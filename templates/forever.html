{% extends "base.html" %}

{% block title %}Forever Orders{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">Create Forever Super Order (Retry until accepted)</div>
  <form method="POST" action="{{ url_for('forever_create') }}" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px;">
    <div>
      <label>Symbol</label>
      <input type="text" name="symbol" placeholder="SBIN" required />
    </div>
    <div>
      <label>Exchange</label>
      <select name="exchange">
        <option>NSE</option>
        <option>BSE</option>
        <option>NFO</option>
        <option>BFO</option>
      </select>
    </div>
    <div>
      <label>Txn Type</label>
      <select name="txn_type">
        <option>BUY</option>
        <option>SELL</option>
      </select>
    </div>
    <div>
      <label>Quantity</label>
      <input type="number" name="qty" min="1" value="1" required />
    </div>
    <div>
      <label>Order Type</label>
      <select name="order_type">
        <option>MARKET</option>
        <option>LIMIT</option>
      </select>
    </div>
    <div>
      <label>Limit Price</label>
      <input type="number" step="0.05" name="price" placeholder="Leave blank for MARKET" />
    </div>
    <div>
      <label>Product</label>
      <select name="product">
        <option>INTRADAY</option>
        <option>CNC</option>
        <option>MARGIN</option>
        <option>MTF</option>
      </select>
    </div>
    <div>
      <label>Target Price</label>
      <input type="number" step="0.05" name="target_price" required />
    </div>
    <div>
      <label>Stop Loss</label>
      <input type="number" step="0.05" name="stop_loss_price" required />
    </div>
    <div>
      <label>Trailing Jump</label>
      <input type="number" step="0.05" name="trailing_jump" value="0" />
    </div>
    <div>
      <label>Tag</label>
      <input type="text" name="tag" placeholder="optional" />
    </div>
    <div>
      <label>Retry Interval (sec)</label>
      <input type="number" name="interval_sec" min="5" value="30" />
    </div>

    <div style="grid-column: 1 / -1; text-align:right; margin-top:8px;">
      <button class="btn btn-primary" type="submit">Create Forever Order</button>
    </div>
  </form>
</div>

<div class="card" style="margin-top:16px;">
  <div class="card-header">Forever Orders</div>
  <div style="overflow:auto;">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Created</th>
          <th>Status</th>
          <th>Symbol</th>
          <th>Txn</th>
          <th>Qty</th>
          <th>Type</th>
          <th>Price</th>
          <th>Attempts</th>
          <th>Last Error</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for o in orders %}
        <tr>
          <td style="font-family:monospace;">{{ o.id[:8] }}â€¦</td>
          <td>{{ o.created_at }}</td>
          <td>{{ o.status }}</td>
          <td>{{ o.order_data.symbol }}</td>
          <td>{{ o.order_data.txn_type }}</td>
          <td>{{ o.order_data.qty }}</td>
          <td>{{ o.order_data.order_type }}</td>
          <td>{{ o.order_data.price or 'MARKET' }}</td>
          <td>{{ o.attempt_count }}</td>
          <td style="max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="{{ o.last_error }}">{{ o.last_error or '-' }}</td>
          <td>
            {% if o.status != 'canceled' and o.status != 'triggered' %}
            <form method="POST" action="{{ url_for('forever_cancel', order_id=o.id) }}">
              <button class="btn btn-secondary" type="submit">Cancel</button>
            </form>
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
