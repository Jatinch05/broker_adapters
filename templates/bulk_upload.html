{% extends "base.html" %}

{% block title %}Bulk Order Upload{% endblock %}

{% block content %}
<div class="container">
    <h1>üìä Bulk Order Upload</h1>
    <p class="subtitle">Upload an Excel or CSV file to place multiple orders at once</p>

    <!-- Instructions Card -->
    <div class="card" style="margin-bottom: 30px;">
        <h2>üìù Instructions</h2>
        <ol style="line-height: 1.8;">
            <li><strong>Download Template:</strong> <a href="/static/sample_orders.xlsx" download style="color: #667eea;">sample_orders.xlsx</a> (Excel)</li>
            <li><strong>Alternative Combined Sample:</strong> <a href="/static/combined_orders.csv" download style="color: #667eea;">combined_orders.csv</a> (CSV with SUPER + FOREVER examples)</li>
            <li><strong>Fill in your orders</strong> following the format</li>
            <li><strong>Upload the file</strong> using the form below</li>
            <li><strong>Review results</strong> and check order history</li>
        </ol>
        
        <h3 style="margin-top: 20px;">üìã Required Columns (Unified Super/Forever):</h3>
        <ul style="line-height: 1.8;">
            <li><code>Symbol</code> - Trading symbol (e.g., HDFCBANK, RELIANCE)</li>
            <li><code>Exchange</code> - NSE or BSE</li>
            <li><code>TransactionType</code> - BUY or SELL</li>
            <li><code>Quantity</code> - Number of shares/lots</li>
            <li><code>OrderType</code> - LIMIT or MARKET</li>
            <li><code>ProductType</code> - SUPER: CNC/INTRADAY/MARGIN/MTF, FOREVER: CNC/MTF</li>
            <li><code>DhanOrderType</code> - SUPER or FOREVER (preferred; if omitted, we auto-detect FOREVER when <code>TriggerPrice</code> is present)</li>
        </ul>
        
        <h3 style="margin-top: 20px;">üìã Optional/Flow-Specific Columns:</h3>
        <ul style="line-height: 1.8;">
            <li><strong>SUPER</strong>: <code>TargetPrice</code>, <code>StopLoss</code>, <code>TrailingStopLoss</code>, optional <code>Price</code>, <code>Tag</code></li>
            <li><strong>FOREVER</strong>: <code>TriggerPrice</code> (required), <code>Price</code> (required even for MARKET), <code>OrderFlag</code> (SINGLE/OCO), <code>Validity</code> (DAY/IOC), <code>DisclosedQuantity</code></li>
            <li><strong>FOREVER (OCO)</strong>: <code>Price1</code>, <code>TriggerPrice1</code>, <code>Quantity1</code></li>
            <li><strong>Optional (Derivatives)</strong>: <code>StrikePrice</code>, <code>ExpiryDate</code>, <code>OptionType</code></li>
        </ul>
        
        <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
            <strong>üìå Note for SENSEX Options:</strong>
            <p style="margin: 5px 0 0 0; font-size: 0.95em;">
                SENSEX options use symbol <code>BSXOPT</code>. To specify which contract, add:
                <code>StrikePrice</code>, <code>ExpiryDate</code>, and <code>OptionType</code> columns.
            </p>
        </div>
    </div>

    <!-- Upload Form -->
    <div class="card" style="margin-bottom: 30px;">
        <h2>üì§ Upload Orders File</h2>
        {% if bulk_in_progress and job %}
        <div style="margin-bottom: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
            Bulk job {{ job.id }} is {{ job.status }}. You can cancel it below.
        </div>
        {% endif %}
        <form method="POST" action="{{ url_for('bulk_upload') }}" enctype="multipart/form-data">
            <div class="form-group">
                  <label for="bulkFileInput">Select File (.xlsx, .xls, .csv)</label>
                <input type="file" id="bulkFileInput" name="file" accept=".xlsx,.xls,.csv" required {% if bulk_in_progress %}disabled{% endif %}
                       style="width: 100%; padding: 10px; border: 2px dashed #667eea; border-radius: 8px; background: #f8f9fa;">
            </div>
            <button id="bulkUploadBtn" type="submit" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.1em;" {% if bulk_in_progress %}disabled{% endif %}>
                üöÄ Upload and Place Orders
            </button>
        </form>
        {% if bulk_in_progress and job %}
        <div id="bulkUploadDisabledHint" style="margin-top: 10px; color: #6b7280; font-size: 0.95em;">
            Upload is disabled while job {{ job.id }} is {{ job.status }}.
        </div>
        {% endif %}
        {% if bulk_in_progress and job %}
        <form id="bulkCancelForm" method="POST" action="{{ url_for('bulk_cancel', job_id=job.id) }}" style="margin-top: 12px;">
            <button id="bulkCancelBtn" type="submit" class="btn btn-secondary" style="width: 100%; padding: 12px;">
                üõë Cancel Running Bulk
            </button>
        </form>
        {% endif %}
    </div>

    {% if job %}
    <div class="card" style="margin-bottom: 30px;">
        <h2>üì° Bulk Job Status</h2>
        {% set processed = (success_count or 0) + (failed_count or 0) %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
            <div class="stat-chip">Job ID: <span id="bulkJobId">{{ job.id }}</span></div>
            <div class="stat-chip">Status: <span id="bulkJobStatus">{{ job.status }}</span></div>
            <div class="stat-chip">Message: <span id="bulkJobMessage">{{ job.message }}</span></div>
            <div class="stat-chip">Total: <span id="bulkJobTotal">{{ job.total }}</span></div>
            <div class="stat-chip">Success: <span id="bulkJobSuccess">{{ success_count or 0 }}</span></div>
            <div class="stat-chip">Failed: <span id="bulkJobFailed">{{ failed_count or 0 }}</span></div>
            {% if job.perf %}
            <div class="stat-chip">
                Prefetch: {{ job.perf.prefetch_s if job.perf.prefetch_s is not none else '-' }}s
            </div>
            <div class="stat-chip">
                Avg/Order: build {{ job.perf.avg_build_s if job.perf.avg_build_s is not none else '-' }}s,
                wait {{ job.perf.avg_rate_wait_s if job.perf.avg_rate_wait_s is not none else '-' }}s,
                api {{ job.perf.avg_api_s if job.perf.avg_api_s is not none else '-' }}s
            </div>
            {% endif %}
        </div>
        <div style="margin-top: 10px;">
            <div style="display:flex; justify-content: space-between; font-size: 0.95em; color: #374151; margin-bottom: 6px;">
                <div id="bulkProcessedText">Processed: {{ processed }} / {{ job.total }}</div>
                <div id="bulkPercentText">{% if job.total and job.total > 0 %}{{ ((processed / job.total) * 100) | round(1) }}%{% else %}0%{% endif %}</div>
            </div>
            <div style="height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden;">
                <div id="bulkProgressBar" style="height: 10px; width: {% if job.total and job.total > 0 %}{{ ((processed / job.total) * 100) }}{% else %}0{% endif %}%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
            </div>
        </div>
        <div id="bulkLastUpdated" style="margin-top: 8px; color: #6b7280; font-size: 0.9em;"></div>
        <div id="bulkAutoRefreshHint" style="margin-top: 6px; color: #6b7280; {% if not bulk_in_progress %}display:none;{% endif %}">Auto-refreshing every 2s‚Ä¶</div>
    </div>
    {% endif %}

    <!-- Results Section -->
    {% if job %}
    <div class="card">
        <h2>üìà Upload Results</h2>
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; text-align: center;">
                <div id="bulkResultsTotal" style="font-size: 2em; font-weight: bold;">{{ results|length }}</div>
                <div>Total Orders</div>
            </div>
            <div style="flex: 1; padding: 15px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 8px; text-align: center;">
                <div id="bulkResultsSuccess" style="font-size: 2em; font-weight: bold;">{{ success_count }}</div>
                <div>Successful</div>
            </div>
            <div style="flex: 1; padding: 15px; background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); color: white; border-radius: 8px; text-align: center;">
                <div id="bulkResultsFailed" style="font-size: 2em; font-weight: bold;">{{ failed_count }}</div>
                <div>Failed</div>
            </div>
        </div>

        {% if not results %}
        <div style="margin: 10px 0 16px; color: #6b7280;">
            {% if bulk_in_progress %}
                Waiting for results‚Ä¶ this table will fill as orders are processed.
            {% else %}
                No per-row results available for this job.
            {% endif %}
        </div>
        {% endif %}

        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <th style="padding: 12px; text-align: left;">Row</th>
                        <th style="padding: 12px; text-align: left;">Symbol</th>
                        <th style="padding: 12px; text-align: left;">Status</th>
                        <th style="padding: 12px; text-align: left;">Order ID</th>
                        <th style="padding: 12px; text-align: left;">Message</th>
                    </tr>
                </thead>
                <tbody id="bulkResultsBody">
                    {% for result in results %}
                    <tr style="border-bottom: 1px solid #e0e0e0; {% if loop.index % 2 == 0 %}background: #f8f9fa;{% endif %}">
                        <td style="padding: 12px;">{{ result.row }}</td>
                        <td style="padding: 12px; font-weight: bold;">{{ result.symbol }}</td>
                        <td style="padding: 12px;">
                            {% if result.status == 'Success' %}
                                <span style="background: #38ef7d; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em;">‚úì Success</span>
                            {% else %}
                                <span style="background: #ff6a00; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em;">‚úó Failed</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px; font-family: monospace;">{{ result.order_id or 'N/A' }}</td>
                        <td style="padding: 12px; font-size: 0.9em;">{{ result.message }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div style="margin-top: 20px; text-align: center;">
            <a href="{{ url_for('order_history_page') }}" class="btn btn-primary">
                üìú View Full Order History
            </a>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .subtitle {
        color: #666;
        font-size: 1.1em;
        margin-bottom: 30px;
    }

    code {
        background: #f0f0f0;
        padding: 2px 8px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        color: #667eea;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }

    .btn {
        text-decoration: none;
        border: none;
        cursor: pointer;
        font-size: 1em;
        border-radius: 8px;
        transition: all 0.3s ease;
        display: inline-block;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 30px;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .stat-chip {
        padding: 10px;
        background: #f3f4f6;
        border-radius: 8px;
        font-size: 0.95em;
        color: #374151;
    }

    @media (max-width: 768px) {
        h1 {
            font-size: 2em;
        }

        table {
            font-size: 0.9em;
        }

        th, td {
            padding: 8px !important;
        }
    }
</style>
{% if job %}
<script>
const jobId = "{{ job.id }}";
const statusUrlBase = `/bulk-status/${jobId}/json`;
const terminal = new Set(['completed', 'failed', 'cancelled']);
let didHardReload = false;

// If the browser restores this page from back/forward cache, force a reload
// so we don't keep showing results from an older job.
window.addEventListener('pageshow', (evt) => {
    if (evt.persisted) window.location.reload();
});

// Note: Do not clear server-rendered results here.

function escapeHtml(s) {
    return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
}

async function pollJob(){
    try {
        const res = await fetch(`${statusUrlBase}?t=${Date.now()}`, { cache: 'no-store' });
        if(res.status === 404 && !didHardReload){
            didHardReload = true;
            window.location.reload();
            return;
        }
        if(!res.ok) return;
        const data = await res.json();
        if(data.status){
            // Safety: if server returns a different job id, reload.
            if (data.id && String(data.id) !== String(jobId)) {
                window.location.reload();
                return;
            }
            const idEl = document.getElementById('bulkJobId');
            if(idEl) idEl.textContent = String(data.id || jobId);

            const statusEl = document.getElementById('bulkJobStatus');
            if(statusEl) statusEl.textContent = data.status;
            const msgEl = document.getElementById('bulkJobMessage');
            if(msgEl) msgEl.textContent = data.message || '';
            const succEl = document.getElementById('bulkJobSuccess');
            if(succEl) succEl.textContent = String(data.success_count || 0);
            const failEl = document.getElementById('bulkJobFailed');
            if(failEl) failEl.textContent = String(data.failed_count || 0);

            // Keep results summary chips in sync too
            const resultsTotalEl = document.getElementById('bulkResultsTotal');
            if(resultsTotalEl) resultsTotalEl.textContent = String((data.success_count || 0) + (data.failed_count || 0));
            const resultsSuccEl = document.getElementById('bulkResultsSuccess');
            if(resultsSuccEl) resultsSuccEl.textContent = String(data.success_count || 0);
            const resultsFailEl = document.getElementById('bulkResultsFailed');
            if(resultsFailEl) resultsFailEl.textContent = String(data.failed_count || 0);

            const total = Number(data.total || 0);
            const processed = Number((data.success_count || 0) + (data.failed_count || 0));
            const pct = total > 0 ? (processed / total) * 100 : 0;
            const processedText = document.getElementById('bulkProcessedText');
            if(processedText) processedText.textContent = `Processed: ${processed} / ${total}`;
            const pctText = document.getElementById('bulkPercentText');
            if(pctText) pctText.textContent = `${pct.toFixed(1)}%`;
            const bar = document.getElementById('bulkProgressBar');
            if(bar) bar.style.width = `${pct}%`;

            const lastUpdated = document.getElementById('bulkLastUpdated');
            if(lastUpdated) lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

            // Toggle the "auto refreshing" hint based on the polled status
            const hint = document.getElementById('bulkAutoRefreshHint');
            if(hint){
                hint.style.display = terminal.has(data.status) ? 'none' : '';
            }

            // Update perf chips if present
            if(data.perf){
                const chips = document.querySelectorAll('.stat-chip');
                for(const chip of chips){
                    const txt = chip.textContent || '';
                    if(txt.trim().startsWith('Prefetch:')){
                        const v = (data.perf.prefetch_s === null || data.perf.prefetch_s === undefined) ? '-' : data.perf.prefetch_s;
                        chip.textContent = `Prefetch: ${v}s`;
                    }
                    if(txt.includes('Avg/Order: build')){
                        const b = (data.perf.avg_build_s === null || data.perf.avg_build_s === undefined) ? '-' : data.perf.avg_build_s;
                        const w = (data.perf.avg_rate_wait_s === null || data.perf.avg_rate_wait_s === undefined) ? '-' : data.perf.avg_rate_wait_s;
                        const a = (data.perf.avg_api_s === null || data.perf.avg_api_s === undefined) ? '-' : data.perf.avg_api_s;
                        chip.textContent = `Avg/Order: build ${b}s, wait ${w}s, api ${a}s`;
                    }
                }
            }

            // Show last ~20 results live (from JSON)
            if(Array.isArray(data.results)){
                const tableBody = document.getElementById('bulkResultsBody');
                if(tableBody){
                    const rows = data.results.map(r => {
                        const ok = r.status === 'Success';
                        const badge = ok
                            ? '<span style="background: #38ef7d; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em;">‚úì Success</span>'
                            : '<span style="background: #ff6a00; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.9em;">‚úó Failed</span>';
                        return `
                            <tr style="border-bottom: 1px solid #e0e0e0;">
                                <td style="padding: 12px;">${escapeHtml(r.row)}</td>
                                <td style="padding: 12px; font-weight: bold;">${escapeHtml(r.symbol)}</td>
                                <td style="padding: 12px;">${badge}</td>
                                <td style="padding: 12px; font-family: monospace;">${escapeHtml(r.order_id || 'N/A')}</td>
                                <td style="padding: 12px; font-size: 0.9em;">${escapeHtml(r.message || '')}</td>
                            </tr>`;
                    }).join('');
                    tableBody.innerHTML = rows;
                }
            }

            if(terminal.has(data.status)){
                // Job is finished; stop polling (avoid flicker / infinite reload loops)
                if (pollHandle) clearInterval(pollHandle);

                // Re-enable upload UI now that the job is finished
                const fileInput = document.getElementById('bulkFileInput');
                if(fileInput) fileInput.disabled = false;
                const uploadBtn = document.getElementById('bulkUploadBtn');
                if(uploadBtn) uploadBtn.disabled = false;
                const uploadHint = document.getElementById('bulkUploadDisabledHint');
                if(uploadHint) uploadHint.style.display = 'none';

                // Hide cancel UI once job is finished
                const cancelForm = document.getElementById('bulkCancelForm');
                if(cancelForm) cancelForm.style.display = 'none';
            }
        }
    } catch(e){
        console.warn('Polling error', e);
    }
}
let pollHandle = null;
// Always fetch once to hydrate final results (important in multi-process setups).
pollJob();
// Always start polling; stop as soon as the polled status is terminal.
pollHandle = setInterval(pollJob, 2000);
</script>
{% endif %}
{% endblock %}
