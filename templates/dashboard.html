{% extends "base.html" %}

{% block title %}Dashboard - Dhan Super Orders{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="value">{{ order_count }}</div>
        <div class="label">Orders Placed</div>
    </div>
    <div class="stat-card">
        <div class="value">âœ“</div>
        <div class="label">Connected</div>
    </div>
    <div class="stat-card">
        <div class="value">ğŸš€</div>
        <div class="label">Ready to Trade</div>
    </div>
</div>

<div class="card">
    <div class="card-header">Welcome to Dhan Super Orders</div>
    
    <p style="margin-bottom: 20px; color: #6b7280;">
        You're logged in as: <strong style="color: #667eea;">{{ client_id }}</strong>
    </p>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div style="padding: 20px; border: 2px solid #e5e7eb; border-radius: 8px; text-align: center;">
            <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“</div>
            <h3 style="margin-bottom: 10px; color: #333;">Place New Order</h3>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 15px;">
                Create a new super order with target and stop loss
            </p>
            <a href="{{ url_for('place_order') }}" class="btn btn-primary">
                Place Order â†’
            </a>
        </div>

        <div style="padding: 20px; border: 2px solid #e5e7eb; border-radius: 8px; text-align: center;">
            <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“Š</div>
            <h3 style="margin-bottom: 10px; color: #333;">Bulk Upload</h3>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 15px;">
                Upload Excel file to place multiple orders at once
            </p>
            <a href="{{ url_for('bulk_upload') }}" class="btn btn-primary" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                Upload Orders â†’
            </a>
        </div>

        <div style="padding: 20px; border: 2px solid #e5e7eb; border-radius: 8px; text-align: center;">
            <div style="font-size: 36px; margin-bottom: 10px;">ğŸ“œ</div>
            <h3 style="margin-bottom: 10px; color: #333;">Order History</h3>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 15px;">
                View all your placed orders and their status
            </p>
            <a href="{{ url_for('order_history_page') }}" class="btn btn-secondary">
                View History â†’
            </a>
        </div>

        <div style="padding: 20px; border: 2px solid #e5e7eb; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="font-size: 20px; font-weight: 600; color: #333; display: flex; gap: 10px; align-items: center;">
                    <span>â³</span> <span>Deferred Super Queue</span>
                </div>
                <form method="POST" action="{{ url_for('deferred_queue_clear') }}" onsubmit="return confirm('Clear all queued deferred Super orders?');">
                    <button type="submit" class="btn btn-secondary" style="padding: 8px 14px;">Clear</button>
                </form>
            </div>
            <div id="deferredSummary" style="font-size: 14px; color: #374151; margin-bottom: 8px;">Loading queueâ€¦</div>
            <div id="deferredList" style="display: grid; gap: 8px;"></div>
            <div id="deferredEmpty" style="color: #6b7280; font-size: 13px; display: none;">No deferred Super buys queued.</div>
        </div>


        <div style="padding: 20px; border: 2px solid #e5e7eb; border-radius: 8px; text-align: center;">
            <div style="font-size: 36px; margin-bottom: 10px;">ğŸ”„</div>
            <h3 style="margin-bottom: 10px; color: #333;">Refresh Instruments</h3>
            <p style="color: #6b7280; font-size: 14px; margin-bottom: 15px;">
                Update the latest instrument data from Dhan
            </p>
            <form method="POST" action="{{ url_for('refresh_instruments') }}" style="display: inline;">
                <button type="submit" class="btn btn-success">
                    Refresh Data
                </button>
            </form>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">What is a Super Order?</div>
    
    <div style="display: grid; gap: 15px;">
        <div style="padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #667eea;">
            <strong style="color: #333;">ğŸ“Œ Entry Leg</strong>
            <p style="color: #6b7280; font-size: 14px; margin-top: 5px;">
                Your main order - BUY or SELL at market or limit price
            </p>
        </div>

        <div style="padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #10b981;">
            <strong style="color: #333;">ğŸ¯ Target Leg</strong>
            <p style="color: #6b7280; font-size: 14px; margin-top: 5px;">
                Take profit - automatically exits when target price is reached
            </p>
        </div>

        <div style="padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #ef4444;">
            <strong style="color: #333;">ğŸ›¡ï¸ Stop Loss Leg</strong>
            <p style="color: #6b7280; font-size: 14px; margin-top: 5px;">
                Protection - exits if price moves against you (with optional trailing)
            </p>
        </div>
    </div>
</div>

<script>
async function loadDeferredQueue() {
    try {
        const res = await fetch('{{ url_for('deferred_queue') }}');
        if (!res.ok) throw new Error('Failed to load queue');
        const data = await res.json();
        const items = data.items || [];
        const summary = document.getElementById('deferredSummary');
        const list = document.getElementById('deferredList');
        const empty = document.getElementById('deferredEmpty');
        summary.textContent = `${items.length} queued (auto-placed when LTP enters tolerance band)`;
        list.innerHTML = '';
        if (!items.length) {
            empty.style.display = 'block';
            return;
        }
        empty.style.display = 'none';
        items.slice(0, 6).forEach(item => {
            const card = document.createElement('div');
            card.style.padding = '10px';
            card.style.border = '1px solid #e5e7eb';
            card.style.borderRadius = '8px';
            card.style.background = '#f9fafb';
            card.innerHTML = `
                <div style="display:flex; justify-content: space-between; font-weight: 600; color: #111827;">
                    <span>${item.symbol} (${item.exchange_segment})</span>
                    <span style="color: ${item.status === 'pending' ? '#f97316' : '#10b981'};">${item.status}</span>
                </div>
                <div style="margin-top: 4px; font-size: 13px; color: #374151;">Trigger: ${item.trigger_price} | Tol: ${item.tolerance_pct}% | LTP: ${item.last_ltp || 'â€”'}</div>
                <div style="margin-top: 2px; font-size: 12px; color: #6b7280;">Updated: ${item.updated_at || item.created_at}</div>
            `;
            list.appendChild(card);
        });
    } catch (e) {
        const summary = document.getElementById('deferredSummary');
        summary.textContent = 'Unable to load deferred queue.';
    }
}

loadDeferredQueue();
setInterval(loadDeferredQueue, 5000);
</script>
{% endblock %}
